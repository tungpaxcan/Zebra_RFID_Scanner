
@{
    ViewBag.Title = @Html.DisplayName(CollTex.Resources.Resource.inputepcdata);
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="card card-custom" id="a">
    <div class=" flex-wrap py-5" style="padding: 7.25rem;">
        <!--begin::Dropdown-->
        <div class="card-toolbar">
            <form class="row" enctype="multipart/form-data">
                <button type="submit" name="submit" value="" class="btn btn-light-primary font-weight-bolder col-sm-3 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
                    <span class="svg-icon svg-icon-md">

                        <!--begin::Svg Icon | path:assets/media/svg/icons/Design/PenAndRuller.svg-->
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <rect x="0" y="0" width="24" height="24"></rect>
                                <path d="M3,16 L5,16 C5.55228475,16 6,15.5522847 6,15 C6,14.4477153 5.55228475,14 5,14 L3,14 L3,12 L5,12 C5.55228475,12 6,11.5522847 6,11 C6,10.4477153 5.55228475,10 5,10 L3,10 L3,8 L5,8 C5.55228475,8 6,7.55228475 6,7 C6,6.44771525 5.55228475,6 5,6 L3,6 L3,4 C3,3.44771525 3.44771525,3 4,3 L10,3 C10.5522847,3 11,3.44771525 11,4 L11,19 C11,19.5522847 10.5522847,20 10,20 L4,20 C3.44771525,20 3,19.5522847 3,19 L3,16 Z" fill="#000000" opacity="0.3"></path>
                                <path d="M16,3 L19,3 C20.1045695,3 21,3.8954305 21,5 L21,15.2485298 C21,15.7329761 20.8241635,16.200956 20.5051534,16.565539 L17.8762883,19.5699562 C17.6944473,19.7777745 17.378566,19.7988332 17.1707477,19.6169922 C17.1540423,19.602375 17.1383289,19.5866616 17.1237117,19.5699562 L14.4948466,16.565539 C14.1758365,16.200956 14,15.7329761 14,15.2485298 L14,5 C14,3.8954305 14.8954305,3 16,3 Z" fill="#000000"></path>
                            </g>
                        </svg>
                        <!--end::Svg Icon-->
                    </span><a href="~/Images/Epc.xlsx" download="">@Html.DisplayName(CollTex.Resources.Resource.exceltemplate)</a>
                </button>
                <div class="file-upload col-sm-6 col-md-6 col-lg-6 col-xl-6 col-xxl-6">
                    <div class="file-select">
                        <div class="file-select-button" id="fileName">@Html.DisplayName(CollTex.Resources.Resource.choosefile)</div>
                        <div class="file-select-name" id="noFile">@Html.DisplayName(CollTex.Resources.Resource.nofilechosen)...</div>
                        <input type="file" name="UploadedFile" id="chooseFile">
                    </div>
                </div>
                <button onclick="Import()" type="button" name="submit" value="" class="btn btn-light-primary font-weight-bolder col-sm-3 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
                    <span class="svg-icon svg-icon-md">

                        <!--begin::Svg Icon | path:assets/media/svg/icons/Design/PenAndRuller.svg-->
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <rect x="0" y="0" width="24" height="24"></rect>
                                <path d="M3,16 L5,16 C5.55228475,16 6,15.5522847 6,15 C6,14.4477153 5.55228475,14 5,14 L3,14 L3,12 L5,12 C5.55228475,12 6,11.5522847 6,11 C6,10.4477153 5.55228475,10 5,10 L3,10 L3,8 L5,8 C5.55228475,8 6,7.55228475 6,7 C6,6.44771525 5.55228475,6 5,6 L3,6 L3,4 C3,3.44771525 3.44771525,3 4,3 L10,3 C10.5522847,3 11,3.44771525 11,4 L11,19 C11,19.5522847 10.5522847,20 10,20 L4,20 C3.44771525,20 3,19.5522847 3,19 L3,16 Z" fill="#000000" opacity="0.3"></path>
                                <path d="M16,3 L19,3 C20.1045695,3 21,3.8954305 21,5 L21,15.2485298 C21,15.7329761 20.8241635,16.200956 20.5051534,16.565539 L17.8762883,19.5699562 C17.6944473,19.7777745 17.378566,19.7988332 17.1707477,19.6169922 C17.1540423,19.602375 17.1383289,19.5866616 17.1237117,19.5699562 L14.4948466,16.565539 C14.1758365,16.200956 14,15.7329761 14,15.2485298 L14,5 C14,3.8954305 14.8954305,3 16,3 Z" fill="#000000"></path>
                            </g>
                        </svg>
                        <!--end::Svg Icon-->
                    </span>@Html.DisplayName(CollTex.Resources.Resource.import)
                </button>
            </form>

        </div>
        &nbsp
    </div>
    <div class="card-body">
        <!--begin: Datatable-->
        <div id="kt_datatable_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
            <div class="form-group row">
                @*<label for="example-search-input" class="col-sm-1 col-md-2 col-lg-2 col-xl-2 col-xxl-2 col-form-label"></label>*@
                <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12" style="height: 500px;overflow-y: scroll;">
                    <div class="input-group ">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <input type="number" class="form-control" placeholder="@Html.DisplayName(CollTex.Resources.Resource.quantity)" id="amount">
                            </div>
                            <select class="form-control select2" id="kt_select2_1" name="seachidgood">
                            </select>
                        </div>
                    </div>
                    <table class="table table-separate table-head-custom table-checkable dataTable no-footer dtr-inline" id="kt_datatable" role="grid" aria-describedby="kt_datatable_info" style="width: 1234px;">
                        <thead>
                            <tr role="row">
                                <th class="sorting" tabindex="0" aria-controls="kt_datatable" rowspan="1" colspan="1" style="width: 190px;" aria-label="Company Email: activate to sort column ascending">@Html.DisplayName(CollTex.Resources.Resource.id)</th>
                                <th class="sorting" tabindex="0" aria-controls="kt_datatable" rowspan="1" colspan="1" style="width: 190px;" aria-label="Company Email: activate to sort column ascending">EPC</th>
                            </tr>
                        </thead>
                        <tbody id="tbd">
                        </tbody>
                    </table>

                </div>
                <div style=" width:100%;" id="divResult"><p style="text-align: center; transform: translateY(45%); " id="result">@Html.DisplayName(CollTex.Resources.Resource.result)</p></div>
                <button type="submit" class="btn btn-success mr-2 on" onclick="RFID()">@Html.DisplayName(CollTex.Resources.Resource.startRFIDscanning)</button>
                <button type="submit" class="btn btn-secondary mr-2 off" style="display:none" onclick=" Stop()">@Html.DisplayName(CollTex.Resources.Resource.stopRFIDscanning)</button>
                <button type="submit" class="btn btn-primary mr-2" onclick="Add()">@Html.DisplayName(CollTex.Resources.Resource.save)</button>
                <a href="/FunctionOrder/CardRecognition" class="btn btn-danger mr-2">@Html.DisplayName(CollTex.Resources.Resource.reload)</a>
            </div>
        </div>
    </div>

</div>
@section scripts{
    <script src="~/Scripts/ebapi-modules.js"></script>
    <script src="~/Scripts/elements.js"></script>
    <script>
        function Import() {
            try {
                let fileUpload = $('input[name="UploadedFile"]').get(0);
                let files = fileUpload.files;
                let formdata = new FormData();
                formdata.append('file', files[0]);
                $.ajax({
                    type: 'post',
                    url: '/FunctionOrder/Upload',
                    contentType: false,
                    processData: false,
                    data: formdata,
                    success: function (data) {
                        if (data.code == 200) {
                            Swal.fire(data.msg.join("\n"), "@Html.DisplayName(CollTex.Resources.Resource.confirm)!", "success");
                        }

                    }
                })
            } catch (error) {
                Swal.fire(error.message, "", "error")
            }
        }
        $('#chooseFile').bind('change', function () {
            var filename = $("#chooseFile").val();
            if (/^\s*$/.test(filename)) {
                $(".file-upload").removeClass('active'); $("#noFile").empty()
                $("#noFile").append("@Html.DisplayName(CollTex.Resources.Resource.nofilechosen)...");
            }
            else {
                $(".file-upload").addClass('active');
                $("#noFile").text(filename.replace("C:\\fakepath\\", ""));
            }
        });

        //load code goods
        $(function CodeGoods() {
            $.ajax({
                url: '/Goods/CodeGoods',
                type: 'get',
                success: function (data) {
                    if (data.code == 200) {
                        let option = `<option value="-1">@Html.DisplayName(CollTex.Resources.Resource.selectproductcode)</option>`
                        $.each(data.a, function (k, v) {
                            option += `<option value="${v.idgoods}">${v.idgoods}</option>`
                        })
                        $('select[name="seachidgood"]').append(option)
                    }
                }
            })
        })
        var start;
        //start scanner
        function RFID() {
            let id = $('select[name="seachidgood"]').val()
            let amount = $('#amount').val().trim()
            if (id == -1) {
                Swal.fire("@Html.DisplayName(CollTex.Resources.Resource.noproductcodeselected)", "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)!", "warning"); $('select[name="seachidgood"]').css('border-color', "red"); return;
            } else {
                $('select[name="seachidgood"]').css('border-color', "green");
            }
            if (amount.length == 0) {
                Swal.fire("@Html.DisplayName(CollTex.Resources.Resource.noscannumberentered)", "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)!", "warning"); $('#amount').css('border-color', "red"); return;
            } else {
                $('#amount').css('border-color', "green");
            }
            DeleteEPC()
            $('.on').css('display', 'none')
            $('.off').css('display', 'block')
            start = setInterval(function () { AllShowEPC(amount, id) }, 100);
        }

        //stop scanner
        function Stop() {
            $('.on').css('display', 'block')
            $('.off').css('display', 'none')
            clearInterval(start);
        }

        //get epc read it
        function AllShowEPC(amount, id) {
            $.ajax({
                url: '/rfid/AllShowEPC',
                type: 'get',
                success: function (data) {
                    if (data.code == 200) {
                        $.each(data.a, function (k, v) {
                            table(v.epc, amount, id)
                        })
                    }
                }
            })
        }

        //check amount get result
        const checkAmount = (amount) => {
            var amountCheck = Number(amount)
            let amountTr = $('.Ids').length
            if (amountTr == 0) {
                CheckAndChange("@Html.DisplayName(CollTex.Resources.Resource.unavailable)", "white")
            } else if (amountTr < amountCheck) {
                CheckAndChange("@Html.DisplayName(CollTex.Resources.Resource.insufficient)", "red")
            } else if (amountTr == amountCheck) {
                CheckAndChange("@Html.DisplayName(CollTex.Resources.Resource.enough)", "green")
            } else if (amountTr > amountCheck) {
                CheckAndChange("@Html.DisplayName(CollTex.Resources.Resource.residual)", "yellow")
            }
        }

        //function change result
        function CheckAndChange(result, divResult) {
            $('#result').empty()
            $('#result').append(result)
            $('#divResult').css("background", divResult)
        }

        //set table readable  data
        const table = (epc, amount, id) => {
            let ids = $('.Ids').map(function () {
                return this.id;
            }).get();
            //get onemore
            if (ids.includes(epc)) {

            } else {
                let tbd = '<tr id="' + epc + '" class="Ids">'
                tbd += '<td>' + id + '</td>';
                tbd += '<td>' + epc + '</td><';
                $('#tbd').append(tbd)
                checkAmount(amount)
            }
        }
        //save
        const Add = () => {
            let coincide ='' ;
            let amountTr = $('.Ids').length
            let amount = $('#amount').val().trim()
            if (amount != amountTr) {
                Swal.fire("@Html.DisplayName(CollTex.Resources.Resource.unsatisfactory)", "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)", "warning");
                EmptyTable()
                return;
            }
            let epcs = $('.Ids').map(function () {
                return this.id
            }).get();
            let id = $('select[name="seachidgood"]').val();
            if (id == -1) {
                Swal.fire("@Html.DisplayName(CollTex.Resources.Resource.nocodeselected)", "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)", "warning");
                EmptyTable()
                return;
            }
            if (amount.length == 0) {
                 Swal.fire("@Html.DisplayName(CollTex.Resources.Resource.amountnotentered)", "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)", "warning");
                EmptyTable()
                return;
            }
            for (let i = 0; i < epcs.length; i++) {
                let epc = epcs[i]
                $.ajax({
                    url: '/CollTex/Epc',
                    type: 'post',
                    data: {
                        epc, id
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            $('#amount').val('')
                            $('select[name="seachidgood"]').val(-1)
                            if (i == epcs.length - 1) {
                                Swal.fire(data.msg, "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)", "success");
                            }
                        } else if (data.code == 300) {
                            coincide += `${data.msg}\n`
                            console.log(coincide)
                            if (i == epcs.length - 1) {
                                Swal.fire("@Html.DisplayName(CollTex.Resources.Resource.coincide) !!! @Html.DisplayName(CollTex.Resources.Resource.alreadyhaveEPC) " + coincide + " @Html.DisplayName(CollTex.Resources.Resource.inthesystem)", "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)", "error");
                            }
                        } else {   Swal.fire(data.msg, "@Html.DisplayName(CollTex.Resources.Resource.pressthebutton)", "error"); }
                    }
                })
            }
            EmptyTable()
            Stop()
            if ($(window).width() < 800) {
                $('.flex-wrap.py-5 .card-toolbar').css("display", "none")
                $('.btn.btn-success.mr-2.on').css("display", "none")
            } else {

            }
        }

        $(document).ready(function () {
            rfid.tagEvent = "TagHandler(%json)";
            RFIDEnumrate()
            $('#result').empty()
        })

        //read
        var lstEpcSended = [];
        function TagHandler(tagarray) {
            for (i = 0; i < tagarray.TagData.length; i++) {
                var epc = tagarray.TagData[i].tagID
                if (!lstEpcSended.includes(epc)) {  //take only one of each code
                    lstEpcSended.push(epc)
                    let id = $('select[name="seachidgood"]').val()
                    let amount = $('#amount').val().trim();
                    table(epc, amount, id)
                }
            }
        }

        //connect Handler
        function RFIDEnumrate() {

            rfid.transport = 'serial';
            rfid.readerID = 'RFID1';

            rfid.enumerate();
            setTimeout(function () {
                rfid.connect();
            }, 1000);
        }

        if ($(window).width() < 800) {
            $('.flex-wrap.py-5 .card-toolbar').css("display", "none")
            $('.btn.btn-success.mr-2.on').css("display", "none")
        } else {

        }

        function EmptyTable() {
            $('#tbd').empty()
            CheckAndChange("@Html.DisplayName(CollTex.Resources.Resource.unavailable)", "white")
            lstEpcSended = [];
        }

    </script>
    <script src="~/assets/js/pages/crud/forms/widgets/select2.js"></script>

}

